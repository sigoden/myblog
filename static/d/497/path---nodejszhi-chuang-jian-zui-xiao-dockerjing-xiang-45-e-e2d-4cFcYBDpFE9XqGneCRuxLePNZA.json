{"data":{"site":{"siteMetadata":{"title":"Sigoden | Blog","siteUrl":"https://blog.sigoden.com","siteAuthor":"sigoden","githubUrl":"https://github.com/sigoden"}},"markdownRemark":{"html":"<p>使用 docker 运行服务，你可以拥有一致的环境，可以精确控制服务的运行资源 (cpu, 内存），可以方便的设置端口和网络，可以使用镜像仓储管理和分发代码。现在越来越多的开发者选择将服务运行在 docker 上。</p>\n<p>好多 nodejs 用户在使用 docker 时，直接使用了默认的 node 镜像。但你不觉得它太大了吗？现在<code class=\"language-text\">node:6.10.1</code>镜像的体积已经达到 666M，其实要实现同样的功能，只需 43.5M 就够了。尺寸小，意味者更低的资源消耗，更快的下载速度，更小的传输带宽。</p>\n<p>下面一起来揭露技巧。</p>\n<h2 id=\"from-设置-alpine-基础镜像\"><a href=\"#from-%E8%AE%BE%E7%BD%AE-alpine-%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F\" aria-label=\"from 设置 alpine 基础镜像 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FROM: 设置 alpine 基础镜像</h2>\n<p>目前 docker 下最轻量的操作系统是 alpine, 一个 alpine 的体积不到 5M。node 默认镜像依赖的基础镜像是 debian, <code class=\"language-text\">debian:jessie</code>体积已打 123M, 所以想减小尺寸，首要就是从基础镜像切换到 alpine。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM alpine:3.7</code></pre></div>\n<h2 id=\"run-设置-node-用户\"><a href=\"#run-%E8%AE%BE%E7%BD%AE-node-%E7%94%A8%E6%88%B7\" aria-label=\"run 设置 node 用户 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RUN: 设置 node 用户</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">adduser -D -u 1000 node</code></pre></div>\n<p>设置 node 用户是可选的。添加用户后在运行容器是可以指定已 node 用户的身份运行服务</p>\n<h2 id=\"run-安装-node-编译工具\"><a href=\"#run-%E5%AE%89%E8%A3%85-node-%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7\" aria-label=\"run 安装 node 编译工具 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RUN: 安装 node 编译工具</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apk add --no-cache \\\n    libstdc++ \\\n&amp;&amp; apk add --no-cache --virtual .build-deps \\\n    binutils-gold \\\n    curl \\\n    g++ \\\n    gcc \\\n    gnupg \\\n    libgcc \\\n    linux-headers \\\n    make \\\n    python</code></pre></div>\n<ul>\n<li><code class=\"language-text\">apk add --no-cache</code>不使用本地缓存安装包数据库，直接从远程获取安装包信息安装。这样我们就不必通过<code class=\"language-text\">apk update</code>获取安装包数据库了</li>\n<li><code class=\"language-text\">apk add --virtual .build-deps</code>将本次安装的所有包封装成一个名为.build-deps 的虚拟包。这样做的好处是可以通过<code class=\"language-text\">apk del .build-deps</code>一键清除这些包</li>\n</ul>\n<h2 id=\"run-导入-node-源码包公钥\"><a href=\"#run-%E5%AF%BC%E5%85%A5-node-%E6%BA%90%E7%A0%81%E5%8C%85%E5%85%AC%E9%92%A5\" aria-label=\"run 导入 node 源码包公钥 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RUN: 导入 node 源码包公钥</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">for key in \\\n    9554F04D7259F04124DE6B476D5A82AC7E37093B \\\n    94AE36675C464D64BAFA68DD7434390BDBE9B9C5 \\\n    FD3A5288F042B6850C66B31F09FE44734EB7990E \\\n    71DCFD284A79C3B38668286BC97EC7A07EDE3FC1 \\\n    DD8F2338BAE7501E3DD5AC78C273792F7D83545D \\\n    B9AE9905FFD7803F25714661B63B535A4C206CA9 \\\n    C4F0DFFF4E8C1A8236409D08E73BC641CC11F4C8 \\\n    56730D5401028683275BD23C23EFEFE93C4CFFFE \\\n; do \\\ngpg --keyserver ha.pool.sks-keyservers.net --recv-keys &quot;$key&quot;; \\\ndone</code></pre></div>\n<p>这些公钥将用来校验我们通过 curl 下载的 nodejs 源码文件</p>\n<h2 id=\"run-下载并-node-校验源码文件\"><a href=\"#run-%E4%B8%8B%E8%BD%BD%E5%B9%B6-node-%E6%A0%A1%E9%AA%8C%E6%BA%90%E7%A0%81%E6%96%87%E4%BB%B6\" aria-label=\"run 下载并 node 校验源码文件 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RUN: 下载并 node 校验源码文件</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl -SLO &quot;https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION.tar.xz&quot; \\\n&amp;&amp; curl -SLO &quot;https://nodejs.org/dist/v$NODE_VERSION/SHASUMS256.txt.asc&quot; \\\n&amp;&amp; gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.txt.asc \\\n&amp;&amp; grep &quot; node-v$NODE_VERSION.tar.xz\\$&quot; SHASUMS256.txt | sha256sum -c -</code></pre></div>\n<ul>\n<li><code class=\"language-text\">$NODE_VERSION</code>: 指 node 版本，如 6.10.1</li>\n</ul>\n<h2 id=\"run-编译安装-node\"><a href=\"#run-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-node\" aria-label=\"run 编译安装 node permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RUN: 编译安装 node</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">tar -xf &quot;node-v$NODE_VERSION.tar.xz&quot; \\\n&amp;&amp; cd &quot;node-v$NODE_VERSION&quot; \\\n&amp;&amp; ./configure \\\n&amp;&amp; make -j$(getconf _NPROCESSORS_ONLN) \\\n&amp;&amp; make install</code></pre></div>\n<ul>\n<li>如果不需要 npm, 可以替换第三行为<code class=\"language-text\">&amp;&amp; ./configure --without-npm</code></li>\n<li><code class=\"language-text\">$NODE_VERSION</code>: 指 node 版本，如 6.10.1</li>\n</ul>\n<h2 id=\"run-清理\"><a href=\"#run-%E6%B8%85%E7%90%86\" aria-label=\"run 清理 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RUN: 清理</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apk del .build-deps \\\n&amp;&amp; cd .. \\\n&amp;&amp; rm -Rf &quot;node-v$NODE_VERSION&quot; \\\n&amp;&amp; rm &quot;node-v$NODE_VERSION.tar.xz&quot; SHASUMS256.txt.asc SHASUMS256.txt</code></pre></div>\n<ul>\n<li><code class=\"language-text\">$NODE_VERSION</code>: 指 node 版本，如 6.10.1</li>\n</ul>\n<h2 id=\"cmd-设置镜像入口为-node\"><a href=\"#cmd-%E8%AE%BE%E7%BD%AE%E9%95%9C%E5%83%8F%E5%85%A5%E5%8F%A3%E4%B8%BA-node\" aria-label=\"cmd 设置镜像入口为 node permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CMD: 设置镜像入口为 node</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">CMD [ &quot;node&quot; ]</code></pre></div>\n<p>上面为创建 nodejs 镜像必须步骤，下面的步骤根据需要添加</p>\n<h2 id=\"安装-yarn\"><a href=\"#%E5%AE%89%E8%A3%85-yarn\" aria-label=\"安装 yarn permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>安装 yarn</h2>\n<ul>\n<li>\n<p>安装依赖</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apk add --no-cache --virtual .build-deps-yarn curl gnupg</code></pre></div>\n</li>\n<li>\n<p>导入公钥</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">for key in \\\n6A010C5166006599AA17F08146C2130DFD2497F5 \\\n; do \\\ngpg --keyserver ha.pool.sks-keyservers.net --recv-keys &quot;$key&quot;; \\\ndone</code></pre></div>\n</li>\n<li>\n<p>下载校验</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl -fSL -o yarn.js &quot;https://yarnpkg.com/downloads/$YARN_VERSION/yarn-legacy-$YARN_VERSION.js&quot; \\\n&amp;&amp; curl -fSL -o yarn.js.asc &quot;https://yarnpkg.com/downloads/$YARN_VERSION/yarn-legacy-$YARN_VERSION.js.asc&quot; \\\n&amp;&amp; gpg --batch --verify yarn.js.asc yarn.js \\\n&amp;&amp; rm yarn.js.asc</code></pre></div>\n<blockquote>\n<p><code class=\"language-text\">$YARN_VERSION</code>: 指 yarn 版本，如 0.22</p>\n</blockquote>\n</li>\n<li>\n<p>安装</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">mv yarn.js /usr/local/bin/yarn \\\n&amp;&amp; chmod +x /usr/local/bin/yarn \\</code></pre></div>\n</li>\n<li>\n<p>清理</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apk del .build-deps-yarn</code></pre></div>\n<h2 id=\"c-插件\"><a href=\"#c-%E6%8F%92%E4%BB%B6\" aria-label=\"c 插件 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>c++ 插件</h2>\n</li>\n</ul>\n<p>如果要支持 c++ 插件，还需安装 python,make,g++</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apk add --no-cache python make g++</code></pre></div>\n<h2 id=\"headers-文件\"><a href=\"#headers-%E6%96%87%E4%BB%B6\" aria-label=\"headers 文件 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>headers 文件</h2>\n<p>有些 c++ 模块使用过程中还需要下载 node-headers 文件，node-headers 文件国内下载不稳定，建议也集成到镜像里，否则你可能碰到一个包编译很久没动静的情况。</p>\n<ul>\n<li>\n<p>参考 nodejs 源码下载校验步骤对 headers 文件进行下载校验</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl -SLO &quot;https://nodejs.org/dist/v$NODE_VERSION/node-v${NODE_VERSION}-headers.tar.xz&quot;</code></pre></div>\n</li>\n<li>\n<p>安装 headers 文件</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">mkdir /root/.node-gyp\ntar --strip-component 1 -xzf node-v${NODE_VERSION}-heraders.tar.xz /root/.node-gyp/$NODE_VERSION\nrm -rf node-v${NODE_VERSION}-headers.tar.xz</code></pre></div>\n<blockquote>\n<p><code class=\"language-text\">$NODE_VERSION</code>: 指 node 版本，如 6.10.1</p>\n</blockquote>\n</li>\n</ul>","excerpt":"使用 docker 运行服务，你可以拥有一致的环境，可以精确控制服务的运行资源 (cpu, 内存），可以方便的设置端口和网络，可以使用镜像仓储管理和分发代码。现在越来越多的开发者选择将服务运行在 docker 上。 好多 nodejs 用户在使用 docker…","timeToRead":4,"headings":[{"value":"FROM: 设置 alpine 基础镜像","depth":2},{"value":"RUN: 设置 node 用户","depth":2},{"value":"RUN: 安装 node 编译工具","depth":2},{"value":"RUN: 导入 node 源码包公钥","depth":2},{"value":"RUN: 下载并 node 校验源码文件","depth":2},{"value":"RUN: 编译安装 node","depth":2},{"value":"RUN: 清理","depth":2},{"value":"CMD: 设置镜像入口为 node","depth":2},{"value":"安装 yarn","depth":2},{"value":"c++ 插件","depth":2},{"value":"headers 文件","depth":2}],"frontmatter":{"title":"创建极简 nodejs docker 镜像","notoc":null,"excerpt":"本文将介绍如何创建极简 node 镜像","date":"March 26th 2017","rawDate":"2017-03-26T00:00:00.000Z"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/nodejszhi-chuang-jian-zui-xiao-dockerjing-xiang/","prev":{"fields":{"slug":"/shell-can-shu-ti-huan/"},"frontmatter":{"title":"BashScript 参数替换完全指南","draft":null,"tags":["guide","linux","bash"]}},"next":{"fields":{"slug":"/npman-zhuang-de-bao-wei-shi-yao-bu-yi-zhi/"},"frontmatter":{"title":"npm 安装的包为什么不一致","draft":null,"tags":["why","npm","nodejs"]}}}}