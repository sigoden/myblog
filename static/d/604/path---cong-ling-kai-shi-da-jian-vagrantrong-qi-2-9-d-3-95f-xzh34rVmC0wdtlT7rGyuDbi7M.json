{"data":{"site":{"siteMetadata":{"title":"Sigoden | Blog","siteUrl":"https://blog.sigoden.com","siteAuthor":"sigoden","githubUrl":"https://github.com/sigoden"}},"markdownRemark":{"html":"<p>Vagrant 是一个用于创建和部署虚拟化开发环境的工具。vagrant 镜像是一个 vagrant 用来启动虚拟机的文件，通常是纯净的操作系统镜像，如 Ubuntu, Debian，CentOS 打包生成。但我们也可以选择一款操作系统，在其上安装配置我们需要的工具和软件，然后打包成一个自定义 vagrant 镜像。</p>\n<p>我们将通过 virtualbox, 安装运行 ubuntu-server-16.04.2 操作系统，再在其上安装 docker-17.03.0, 然后将这一切打包成为一个名为 ubuntu-16.04-docker-17.03.0 的 vagrant 镜像</p>\n<h2 id=\"准备\"><a href=\"#%E5%87%86%E5%A4%87\" aria-label=\"准备 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>准备</h2>\n<ul>\n<li><a href=\"https://www.virtualbox.org/\">virtualbox</a></li>\n<li><a href=\"https://www.vagrantup.com/downloads.html\">vagrant</a></li>\n<li><a href=\"https://www.ubuntu.com/download/server\">ubuntu-server-16.04.2.iso</a></li>\n</ul>\n<p>下载并安装 vagrant 和 virtualbox, 下载 ubuntu-server-16.04.2.iso 文件</p>\n<h2 id=\"虚拟机安装运行-ubuntu\"><a href=\"#%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%89%E8%A3%85%E8%BF%90%E8%A1%8C-ubuntu\" aria-label=\"虚拟机安装运行 ubuntu permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>虚拟机安装运行 ubuntu</h2>\n<p>配置虚拟机有几点要注意：</p>\n<ul>\n<li>硬盘空间动态且足够，这里选择 8G 默认值</li>\n<li>网路适配器 1(Network > Adapter1) 必须是 NAT, 选择默认值</li>\n<li>内存可以适当小一点，这里选择 512M</li>\n<li>禁掉非必须的硬件比如声卡，USB 控制器</li>\n</ul>\n<p>安装 ubuntu server 时也有几点需要注意：</p>\n<ul>\n<li>安装区域最好选择您所在区域</li>\n<li>用户名设置：vagrant, 密码也是：vagrant</li>\n</ul>\n<h2 id=\"设置-root-密码为-vagrant\"><a href=\"#%E8%AE%BE%E7%BD%AE-root-%E5%AF%86%E7%A0%81%E4%B8%BA-vagrant\" aria-label=\"设置 root 密码为 vagrant permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>设置 root 密码为 vagrant</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo passwd root #连续两次输入 vagrant</code></pre></div>\n<p>检查是否设置成功</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">su - #输入 vagrant 可以切换到 root</code></pre></div>\n<h2 id=\"设置-vagrant-用户无密码运行-sudo\"><a href=\"#%E8%AE%BE%E7%BD%AE-vagrant-%E7%94%A8%E6%88%B7%E6%97%A0%E5%AF%86%E7%A0%81%E8%BF%90%E8%A1%8C-sudo\" aria-label=\"设置 vagrant 用户无密码运行 sudo permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>设置 vagrant 用户无密码运行 sudo</h2>\n<p>需 vagrant 用户需自由运行 sudo 命令而不用输入密码</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo visudo -f /etc/sudoers.d/vagrant</code></pre></div>\n<p>添加下面内容到文件</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">vagrant ALL=(ALL) NOPASSWD:ALL</code></pre></div>\n<p>这样在使用 sudo 时就不必在输入密码了\n可以通过下面命令确认配置是否生效</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo pwd</code></pre></div>\n<h2 id=\"vagrant-用户安装-ssh-公钥\"><a href=\"#vagrant-%E7%94%A8%E6%88%B7%E5%AE%89%E8%A3%85-ssh-%E5%85%AC%E9%92%A5\" aria-label=\"vagrant 用户安装 ssh 公钥 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>vagrant 用户安装 ssh 公钥</h2>\n<p>vagrant 通过 ssh 与虚拟机交互，我们需要从 github 下载公钥安装到 vagrant 用户</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">mkdir -p /home/vagrant/.ssh\nchmod 0700 /home/vagrant/.ssh\nwget --no-check-certificate \\\n    https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub \\\n    -O /home/vagrant/.ssh/authorized_keys\nchmod 0600 /home/vagrant/.ssh/authorized_keys\nchown -R vagrant /home/vagrant/.ssh</code></pre></div>\n<h2 id=\"配置-ssh-服务\"><a href=\"#%E9%85%8D%E7%BD%AE-ssh-%E6%9C%8D%E5%8A%A1\" aria-label=\"配置 ssh 服务 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>配置 SSH 服务</h2>\n<p>安装 ssh 服务器</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo apt-get update -y\nsudo apt-get install -y openssh-server</code></pre></div>\n<p>默认情况下 ssh 会查找 DNS, 离线情况下这种行为会浪费很多时间，所以我们需要配置<code class=\"language-text\">UseDNS no</code>来阻止这种行为</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo vi /etc/ssh/ssh_config</code></pre></div>\n<p>添加</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">UseDNS no</code></pre></div>\n<h2 id=\"安装-virtualbox-guest-additions\"><a href=\"#%E5%AE%89%E8%A3%85-virtualbox-guest-additions\" aria-label=\"安装 virtualbox guest additions permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>安装 VirtualBox Guest Additions</h2>\n<p>VirtualBox Guest Additions 提供了共享文件夹功能，此为对性能还有一些优化，所以有必要安装</p>\n<ul>\n<li>\n<p>更新应用包</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo apt-get update -y\nsudo apt-get upgrade -y</code></pre></div>\n</li>\n<li>\n<p>安装依赖</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo apt-get install -y linux-headers-$(uname -r) build-essential dkms</code></pre></div>\n</li>\n<li>\n<p>安装 VBoxLinuxAdditions</p>\n<blockquote>\n</blockquote>\n</li>\n<li>\n<p>点击 Virtualbox 菜单：devices > Insert Guset Additions CD Image.. 挂载镜像</p>\n</li>\n<li>\n<p>挂载镜像到文件系统<code class=\"language-text\">sudo mount /dev/cdrom /media/cdrom</code></p>\n</li>\n<li>\n<p>运行安装脚本<code class=\"language-text\">sudo sh /media/cdrom/VBoxLinuxAdditions.run</code></p>\n</li>\n</ul>\n<h2 id=\"自定义\"><a href=\"#%E8%87%AA%E5%AE%9A%E4%B9%89\" aria-label=\"自定义 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>自定义</h2>\n<p>这步是可选步骤</p>\n<p>我们也可以安装一些我们喜欢的工具，进行一些常用配置\n此处我们安装 docker</p>\n<p>通过阿里云镜像网站安装 docker 最新版</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl -sSL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/internet | sudo sh -</code></pre></div>\n<p>将 vagrant 用户加入到 docker 组</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo usermod -aG docker vagrant</code></pre></div>\n<h2 id=\"清理\"><a href=\"#%E6%B8%85%E7%90%86\" aria-label=\"清理 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>清理</h2>\n<p>为了尽可能减小镜像的体积，我们进行一些清理</p>\n<p>首先清理安装包</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo apt-get clean</code></pre></div>\n<p>磁盘碎片整理</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo dd if=/dev/zero of=/EMPTY bs=1M\nsudo rm -f /EMPTY</code></pre></div>\n<p>清除 Bash 历史</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">echo &gt; ~/.bash_history &amp;&amp; history -c</code></pre></div>\n<h2 id=\"打包\"><a href=\"#%E6%89%93%E5%8C%85\" aria-label=\"打包 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>打包</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">vagrant package --output ubuntu-16.04-docker-17.03.0.box --base ubuntu</code></pre></div>\n<ul>\n<li><code class=\"language-text\">output</code>: 输出镜像文件位置</li>\n<li><code class=\"language-text\">base</code>: 从运行中虚拟机 ubuntu 导出镜像</li>\n</ul>\n<h2 id=\"结论\"><a href=\"#%E7%BB%93%E8%AE%BA\" aria-label=\"结论 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>结论</h2>\n<p>到此，我们的自定义 vagrant 镜像就算制作完成了，你可以导入后运行，也可以分享给好友和同事。</p>","excerpt":"Vagrant 是一个用于创建和部署虚拟化开发环境的工具。vagrant 镜像是一个 vagrant 用来启动虚拟机的文件，通常是纯净的操作系统镜像，如 Ubuntu, Debian，CentOS…","timeToRead":3,"headings":[{"value":"准备","depth":2},{"value":"虚拟机安装运行 ubuntu","depth":2},{"value":"设置 root 密码为 vagrant","depth":2},{"value":"设置 vagrant 用户无密码运行 sudo","depth":2},{"value":"vagrant 用户安装 ssh 公钥","depth":2},{"value":"配置 SSH 服务","depth":2},{"value":"安装 VirtualBox Guest Additions","depth":2},{"value":"自定义","depth":2},{"value":"清理","depth":2},{"value":"打包","depth":2},{"value":"结论","depth":2}],"frontmatter":{"title":"从零开始创建 Vagrant 镜像","notoc":null,"excerpt":"通过 vagrant 镜像我们可以再发行版的基础上自定义 Linux 镜像并发布。本文将介绍如何从无到有打造一款 vagrant 镜像。","date":"March 16th 2017","rawDate":"2017-03-16"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/cong-ling-kai-shi-da-jian-vagrantrong-qi-2/","prev":{"fields":{"slug":"/npman-zhuang-de-bao-wei-shi-yao-bu-yi-zhi/"},"frontmatter":{"title":"npm 安装的包为什么不一致","draft":null,"tags":["why","npm","nodejs"]}},"next":{"fields":{"slug":"/dockerda-jian-mongodbfu-zhi-ji-2/"},"frontmatter":{"title":"Docker 搭建 mongodb 复制集","draft":null,"tags":["howto","mongo","docker"]}}}}