{"data":{"site":{"siteMetadata":{"title":"Sigoden | Blog","siteUrl":"https://blog.sigoden.com","siteAuthor":"sigoden","githubUrl":"https://github.com/sigoden"}},"markdownRemark":{"html":"<p>本文将讲述如何使用 Verdaccio  搭建私有 npm 仓储。</p>\n<h2 id=\"入门\"><a href=\"#%E5%85%A5%E9%97%A8\" aria-label=\"入门 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>入门</h2>\n<p>verdaccio 是个发布在 npm 上的命令行工具。可以通过 npm 直接下载安装</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm i -g verdaccio</code></pre></div>\n<p>verdaccio 在文件系统上存储数据，没有额外依赖，而且提供了一套默认配置，我们可以直接启动仓储服务</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ verdaccio\n\n warn --- config file  - /home/ubuntu/.config/verdaccio/config.yaml\n warn --- http address - http://localhost:4873/ - verdaccio/2.3.2</code></pre></div>\n<p>终端上的日志显示了默认配置文件路径和 verdaccio 工作的地址端口</p>\n<p>浏览器打开<code class=\"language-text\">http://localhost:4873/</code> ，页面如下</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2da30c8e79a31ce587e22614b8e10763/9c15e/verdaccio-home-default.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 786px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 46.292585170340686%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABRElEQVQoz5XRvU7CcBQF8L6NYVaZNBFdTDS+hQ/g5EAIlIlNNhs6MZS2CTSUqjFuJk7A1FIGURmMC19agkLpx/FSNGqoBv/JL6dNbk9vWubp6ABd4RiPh7t42NlAe2+LxNDe38Z9LIrWegSttchXfl5/uCO3qyvobkbRIczo5gpvZhWj60tYWhnDC5VUMDynPKP7SgmWWgpyqM5ZavGnchGv9OwMgyWP/81fh/FdF75HZuk4lHPT8Rgv/T76nU7gudcLWIMBppPJfM5ZtLCh7/tYeuuQWSZswLZtiKIIjuOQy/HgeZ4yF+C4U+TzeTi0TVjpr4WapkEQBEiSBFmWg5wpFApQFOV/hWP6ftnsCeLxOFKpFNJpFizLIplMIpFIIJPJBC9dutClH2SaJmq1Kur1OhqNBjFgGAZ0XUez2YTneaGF7+WIfDT77ObcAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #ffffff;\"\n        alt=\"verdaccio\"\n        title=\"\"\n        src=\"/static/2da30c8e79a31ce587e22614b8e10763/73d01/verdaccio-home-default.png\"\n        srcset=\"/static/2da30c8e79a31ce587e22614b8e10763/a3b1f/verdaccio-home-default.png 197w,\n/static/2da30c8e79a31ce587e22614b8e10763/07137/verdaccio-home-default.png 393w,\n/static/2da30c8e79a31ce587e22614b8e10763/73d01/verdaccio-home-default.png 786w,\n/static/2da30c8e79a31ce587e22614b8e10763/9c15e/verdaccio-home-default.png 998w\"\n        sizes=\"(max-width: 786px) 100vw, 786px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>恭喜！仓储搭建并运行成功。</p>\n<h2 id=\"配置\"><a href=\"#%E9%85%8D%E7%BD%AE\" aria-label=\"配置 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>配置</h2>\n<ul>\n<li>\n<p>storage: 设置托管或缓存包的存放目录</p>\n</li>\n<li>\n<p>~~ users: 权限控制，已准备弃用~~</p>\n</li>\n<li>\n<p>auth: 权限控制</p>\n<ul>\n<li>\n<p>htpasswd: 启用 htpasswd 插件管理权限</p>\n<ul>\n<li>file: 制定 htpasswd 文件路径，htpasswd 中存储者用户名和加密过的秘钥</li>\n<li>max_users: 最多允许注册用户数</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>uplinks: 设置外部仓储，如果 verdaccio 找不到请求的包（非 verdaccio 托管），就会查找外部仓储。常见的有</p>\n<ul>\n<li>\n<p>{name}: 外部仓储名称</p>\n<ul>\n<li>url: 访问路径</li>\n<li>timeout: 超时</li>\n<li>maxage: 默认值 2m，2m 钟内不会就同样的请求访问外部仓储</li>\n<li>fail_timeout: 如果外部访问失败，在多长时间内不回重试</li>\n<li>headers: 添加自定义 http 头当外部仓储访问请求中，例如<code class=\"language-text\">authorization: &quot;Basic YourBase64EncodedCredentials==&quot;</code></li>\n<li>cache: 是否启用缓存，默认启用。</li>\n</ul>\n</li>\n</ul>\n<p>常用仓储有</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npmjs:\n  url: https://registry.npmjs.org\nyarnjs:\n  url: https://registry.yarnpkg.com\ncnpmjs:\n  url: https://registry.npm.taobao.org</code></pre></div>\n</li>\n<li>\n<p>packages: 包访问或发布控制</p>\n<ul>\n<li>\n<p>{regexp}: 包名匹配正则。</p>\n<ul>\n<li>access: 访问控制，可选值有<code class=\"language-text\">$all</code>（用户不限制）, <code class=\"language-text\">$anonymous</code>（用户不限制）, <code class=\"language-text\">$authenticated</code>（所有登录用户）,  <code class=\"language-text\">username</code>( 用户名，需指定具体用户，可指定多个用户，用户间空格隔开，如 secret super-secret-area ultra-secret-area)。<del>尽管<code class=\"language-text\">@all</code>, <code class=\"language-text\">@anonymous</code>, <code class=\"language-text\">all</code>, <code class=\"language-text\">undefined</code>, <code class=\"language-text\">anonymous</code>目前仍然可以使用，但已准备废弃。</del></li>\n<li><del>allow_access: access 的别称，已准备弃用。</del></li>\n<li>publish: 发布控制，配置请参考 access</li>\n<li><del>allow_publish: publish 的别称，已准备弃用。</del></li>\n<li>proxy: 代理控制，设置的值必选现在 uplinks 中定义。</li>\n<li><del>proxy_access: proxy 的别称，已准备弃用。</del></li>\n</ul>\n</li>\n</ul>\n<p>常用的包名正则有：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">**         # 匹配任意包\n@*/*       # 匹配任意 scope 包\n@npmuser/* # 匹配 scope 为 npmuser 的包\nnpmuser-*  # 匹配包名有 npmuser- 前缀的包</code></pre></div>\n<p>包名正则规范通 gitignore 一致，verdaccio 内部使用<code class=\"language-text\">minimatch</code>实现的，如果需要书写更复杂的正则，可以参考 <a href=\"https://www.npmjs.com/package/minimatch\">minimatch</a> 文档。</p>\n</li>\n<li>\n<p>web: 前端展示页面控制</p>\n<ul>\n<li>title: 设置页面标题</li>\n<li>logo: 指定 logo 图片文件路径</li>\n</ul>\n</li>\n<li>\n<p>publish: 发布包是的全局配置</p>\n<ul>\n<li>allow_offline: 在外部仓储离线时是否允许发布。在发布包是 verdaccio 会检查依赖包有效性，这个过程中需要访问外部仓储。</li>\n</ul>\n</li>\n<li>\n<p>url_prefix: 设置资源文件路径前缀。默认不需要设置，但如果使用 nginx 代理并改写了请求路径，就需要指定了。</p>\n</li>\n<li>\n<p>listen: 设置服务运行地址端口，默认为 <a href=\"http://localhost:4873\">http://localhost:4873</a></p>\n<p>支持的配置有：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">localhost:4873            # default value\nhttp://localhost:4873     # same thing\n0.0.0.0:4873              # listen on all addresses (INADDR_ANY)\nhttps://example.org:4873  # if you want to use https\n[::1]:4873                # ipv6\nunix:/tmp/verdaccio.sock    # unix socket</code></pre></div>\n</li>\n<li>\n<p>https: HTTPS 证书配置</p>\n<ul>\n<li>key: path/to/server.key</li>\n<li>cert: path/to/server.crt</li>\n<li>ca: path/to/server.pem</li>\n</ul>\n</li>\n<li>\n<p>log: 日志控制</p>\n<ul>\n<li>type: file, stdout, stderr, 其中 stdout 需要同时指定 path</li>\n<li>level: trace | debug | info | http (default) | warn | error | fatal</li>\n<li>format: json | pretty | pretty-timestamped</li>\n</ul>\n</li>\n<li>\n<p>http_proxy: 设置以 http 形式访问外部仓储时使用的代理</p>\n</li>\n<li>\n<p>https_proxy: 设置以 https 形式访问外部仓储时使用的代理</p>\n</li>\n<li>\n<p>no_proxy: 不使用代理的请求路径</p>\n</li>\n<li>\n<p>max<em>body</em>size: 请求时上传的 json 允许的最大值</p>\n</li>\n<li>\n<p>notify: 当有包发布成功时，verdaccio 会发送通知。通知实际上是一次 http 请求。支持配置多套通知</p>\n<ul>\n<li>method: 请求方法 GET,POST 等 HTTP Method</li>\n<li>packagePattern: 包匹配正则， 这儿为 js 正则，仅当发布的包名匹配正则时才发送通知</li>\n<li>packagePatternFlags: js 正则标志位，如<code class=\"language-text\">i</code>忽略大小写</li>\n<li>headers: 自定义请求头</li>\n<li>endpoint: 请求地址</li>\n<li>content: handlebar 格式 html 模板，可以使用变量详见 <a href=\"https://github.com/npm/registry/blob/master/docs/responses/package-metadata.md\">Package Metadata</a></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"演示\"><a href=\"#%E6%BC%94%E7%A4%BA\" aria-label=\"演示 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>演示</h2>\n<p>我们先通过 verdaccio 熟悉一下 npm 包发布流程</p>\n<h3 id=\"公开包\"><a href=\"#%E5%85%AC%E5%BC%80%E5%8C%85\" aria-label=\"公开包 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>公开包</h3>\n<ul>\n<li>项目初始化</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm init -f</code></pre></div>\n<ul>\n<li>编写包代码</li>\n</ul>\n<p>这个包只有一个 index.js 文件</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">module.exports = function () {\n  return &#39;verdaccio works&#39;\n}</code></pre></div>\n<ul>\n<li>注册并登录仓储</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm adduser --registry  http://localhost:4873</code></pre></div>\n<p>输入用户名，密码和邮箱创建用户</p>\n<ul>\n<li>发布包</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm publish --registry http://localhost:4873</code></pre></div>\n<p>刷新页面可以看到我们提交的包出现了</p>\n<ul>\n<li>测试安装</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install &lt;package-name&gt; --registry http://localhost:4873</code></pre></div>\n<p>成功，如果我们退出登录状态后再安装呢</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm logout --registry http://localhost:4873\nnpm install &lt;package-name&gt; --registry http://localhost:4873</code></pre></div>\n<p>也是成功的，这说明 verdaccio 提供的默认配置中所有发布的包都被公开，所有人（包括未登录用户）均可见。</p>\n<h3 id=\"私有包\"><a href=\"#%E7%A7%81%E6%9C%89%E5%8C%85\" aria-label=\"私有包 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>私有包</h3>\n<p>现在配置<code class=\"language-text\">org-</code>前缀的包全部私有</p>\n<p>只需在配置文件 config.yml 中 package 段添加配置</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  &#39;org-*&#39;:\n    access: $authenticated\n    publish: $authenticated\n    proxy: npmjs</code></pre></div>\n<p>这里我们配置了所有<code class=\"language-text\">org-</code>前缀的包只有注册用户才能访问和发布。</p>\n<p>你也可以对 publish 做进一步限制，只有 npmuser 用户才能发布</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  &#39;org-*&#39;:\n    access: $authenticated\n    publish: npmuser\n    proxy: npmjs</code></pre></div>\n<p>注意修改配置后要重启 verdaccio</p>\n<h3 id=\"scope-包\"><a href=\"#scope-%E5%8C%85\" aria-label=\"scope 包 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>scope 包</h3>\n<p>其实加前缀并不是一种很好组织包的方式，npm 提供了更好的名称空间策略 scope</p>\n<p>scope 包包名格式：@scope-name/pkg-name</p>\n<p>初始化包时指定 scope</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm init --scope org</code></pre></div>\n<p>我们可以为 scope 绑定一个仓储</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm login --registry=http://reg.example.com --scope=@org\nnpm config set @org:registry http://reg.example.com</code></pre></div>\n<p>这样凡是碰到 scope 为 @org 的包，npm 将自动切换作业仓储到 scope 绑定的仓储，这提供了一种多仓储策略。</p>\n<p>scope 私有包配置</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  &#39;@org/*&#39;:\n    access: $authenticated\n    publish: $authenticated\n    proxy: npmjs</code></pre></div>\n<h2 id=\"结论\"><a href=\"#%E7%BB%93%E8%AE%BA\" aria-label=\"结论 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>结论</h2>\n<p>使用 verdaccio，我们可以很容易就搭建一套私有 npm 仓储，并能灵活的进行访问控制。</p>","excerpt":"本文将讲述如何使用 Verdaccio  搭建私有 npm 仓储。 入门 verdaccio 是个发布在 npm 上的命令行工具。可以通过 npm 直接下载安装 verdaccio…","timeToRead":4,"headings":[{"value":"入门","depth":2},{"value":"配置","depth":2},{"value":"演示","depth":2},{"value":"公开包","depth":3},{"value":"私有包","depth":3},{"value":"scope 包","depth":3},{"value":"结论","depth":2}],"frontmatter":{"title":"使用 verdaccio 搭建 npm 私有仓储","notoc":null,"excerpt":"私有 npm 仓储可以保护企业的内部库，可以通过缓存加快企业内部包的安装。如何搭建一套私有 npm 仓储呢？","date":"July 29th 2017","rawDate":"2017-07-29"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/verdaccio-private-npm-registry/","prev":{"fields":{"slug":"/build-and-publish-electron-app-with-ci/"},"frontmatter":{"title":"使用 CI 构建和发布 electron 应用","draft":null,"tags":["howto","ci","electron"]}},"next":{"fields":{"slug":"/nginx-how-to-write-conf/"},"frontmatter":{"title":"nginx 配置从入门到精通","draft":null,"tags":["howto","nginx"]}}}}